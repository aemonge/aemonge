#!/usr/bin/env bash
#
# scoder - Safe wrapper for OpenCode using bubblewrap
#
# Homepage: https://github.com/anomalyco/opencode
# Author: Andres Monge (aemonge)
# License: MIT
#

set -euo pipefail

readonly PROGRAM_NAME="scoder"
readonly PROGRAM_VERSION="0.6.0"
readonly OPENCODE_BIN_DEFAULT="/usr/bin/opencode"

# Colors for output
readonly RED='\033[0;31m'
readonly YELLOW='\033[1;33m'
readonly GREEN='\033[0;32m'
readonly NC='\033[0m' # No Color

usage() {
    cat <<'EOF'
scoder 0.6.0
Safe OpenCode wrapper using bubblewrap.

Usage:
  scoder [options] [PROJECT_DIR] [-- [OPENCODE_ARGS...]]

Options:
  -h, --help           Show this help and exit
  -V, --version        Show version and exit
  -n, --no-net         Disable network access inside the sandbox (default: on)
  -b, --bin PATH       Path to opencode binary (default: "opencode")
  --ro                 Mount project directory read-only (safe)
  --rw                 Mount project directory read-write (default, less safe)
  --allow-git          Allow write access to .git directory (default: read-only)
  --restrict-dev       Restrict /dev access to essential devices only

Arguments:
  PROJECT_DIR          Project directory to expose as /workspace (default: $PWD)
  OPENCODE_ARGS        Arguments passed verbatim to opencode after "--"

Environment:
  OPENCODE_BIN         Overrides default opencode binary
  SCODER_NET           "on" to enable network by default ("off" otherwise)
  SCODER_FS_MODE       "ro" (default, secure) or "rw" (allow writes)

Examples:
  scoder --ro                      # read-only sandbox of $PWD
  scoder /home/you/dev/myapp       # read-write access
  scoder -n myproj -- --verbose    # network off, pass --verbose to opencode

Security Note:
  OpenCode config (~/.config/opencode) and data (~/.local/share/opencode)
  are mounted from your real home, but HOME is set to a tmpfs to avoid
  polluting your project directory.

Project-Local Tools:
  Project-local venvs (.venv), cargo (.cargo), node_modules, and go bins
  are automatically accessible. Configure mise for project-local installs:
    mise settings set experimental true
    mise settings set venv_auto_create true
EOF
}

version() {
    echo "${PROGRAM_NAME} ${PROGRAM_VERSION}"
}

error() {
    echo -e "${RED}${PROGRAM_NAME}: $*${NC}" >&2
}

warning() {
    echo -e "${YELLOW}${PROGRAM_NAME}: $*${NC}" >&2
}

info() {
    echo -e "${GREEN}${PROGRAM_NAME}: $*${NC}" >&2
}

# -------- defaults (SECURE BY DEFAULT) --------

OPENCODE_BIN="${OPENCODE_BIN:-${OPENCODE_BIN_DEFAULT}}"
NET_MODE="${SCODER_NET:-on}"
FS_MODE="${SCODER_FS_MODE:-rw}"

PROJECT_DIR=""
OPENCODE_ARGS=()

# -------- option parsing --------

RO_SET=0
RW_SET=0
ALLOW_GIT=0
RESTRICT_DEV=0
PARSE_DONE=0

while [[ $# -gt 0 ]]; do
    if [[ "${PARSE_DONE}" -eq 1 ]]; then
        OPENCODE_ARGS+=("$1")
        shift
        continue
    fi

    case "$1" in
    -h | --help)
        usage
        exit 0
        ;;
    -V | --version)
        version
        exit 0
        ;;
    -n | --no-net)
        NET_MODE="off"
        shift
        ;;
    -b | --bin)
        if [[ $# -lt 2 ]]; then
            error "missing argument for $1"
            exit 1
        fi
        OPENCODE_BIN="$2"
        shift 2
        ;;
    --ro)
        RO_SET=1
        FS_MODE="ro"
        shift
        ;;
    --rw)
        RW_SET=1
        FS_MODE="rw"
        shift
        ;;
    --allow-git)
        ALLOW_GIT=1
        shift
        ;;
    --restrict-dev)
        RESTRICT_DEV=1
        shift
        ;;
    --)
        PARSE_DONE=1
        shift
        ;;
    -*)
        error "unknown option: $1"
        echo "Try '${PROGRAM_NAME} --help' for more information." >&2
        exit 1
        ;;
    *)
        if [[ -z "${PROJECT_DIR}" ]]; then
            PROJECT_DIR="$1"
        else
            error "unexpected argument before '--': $1"
            echo "Try '${PROGRAM_NAME} --help' for more information." >&2
            exit 1
        fi
        shift
        ;;
    esac
done

# Check for conflicting flags
if [[ "${RO_SET}" -eq 1 && "${RW_SET}" -eq 1 ]]; then
    error "--ro and --rw are mutually exclusive"
    exit 1
fi

# PROJECT_DIR default
if [[ -z "${PROJECT_DIR}" ]]; then
    PROJECT_DIR="${PWD}"
fi

# -------- validation --------

if ! command -v bwrap >/dev/null 2>&1; then
    error "bubblewrap (bwrap) not found in PATH"
    error "install: pacman -S bubblewrap   # Arch/Manjaro"
    error "        apt install bubblewrap  # Debian/Ubuntu"
    error "        dnf install bubblewrap  # Fedora/RHEL"
    exit 1
fi

if ! command -v "${OPENCODE_BIN}" >/dev/null 2>&1; then
    error "opencode binary not found: ${OPENCODE_BIN}"
    exit 1
fi

if [[ ! -d "${PROJECT_DIR}" ]]; then
    error "project directory does not exist: ${PROJECT_DIR}"
    exit 1
fi

if [[ "${FS_MODE}" != "ro" && "${FS_MODE}" != "rw" ]]; then
    error "invalid FS mode '${FS_MODE}' (expected 'ro' or 'rw')"
    exit 1
fi

PROJECT_DIR="$(realpath "${PROJECT_DIR}")"

# Ensure OpenCode config/data/cache dirs exist with subdirectories
OPENCODE_CONFIG="${HOME}/.config/opencode"
OPENCODE_DATA="${HOME}/.local/share/opencode"
OPENCODE_CACHE="${HOME}/.cache/opencode"

mkdir -p "${OPENCODE_CONFIG}"
mkdir -p "${OPENCODE_DATA}/sessions"
mkdir -p "${OPENCODE_DATA}/permissions"
mkdir -p "${OPENCODE_CACHE}"

# Network flags
NET_FLAGS=()
if [[ "${NET_MODE}" != "on" ]]; then
    NET_FLAGS+=(--unshare-net)
fi

# FS bind mode
if [[ "${FS_MODE}" = "ro" ]]; then
    BIND_FLAG="--ro-bind"
else
    BIND_FLAG="--bind"
fi

# -------- OPTIMIZED path setup --------

# Base PATH (system bins already mounted via /usr, /bin, etc)
SANDBOX_PATH="/usr/local/bin:/usr/local/sbin:/usr/bin:/usr/sbin:/bin:/sbin"
EXTRA_BINDS=()

# Helper: opt_bind <host_path> <sandbox_path>
opt_bind() {
    local host_p="$1"
    local sand_p="$2"
    if [[ -d "${host_p}" ]]; then
        EXTRA_BINDS+=(--ro-bind "${host_p}" "${sand_p}")
    fi
}

# 1. User binaries (if exists)
if [[ -d "${HOME}/.local/bin" ]]; then
    EXTRA_BINDS+=(--ro-bind "${HOME}/.local/bin" "/home/scoder/.local/bin")
    SANDBOX_PATH="${SANDBOX_PATH}:/home/scoder/.local/bin"
fi

# 2. Mise (Version Manager)
#    - Config: Read-Only
#    - Installs: Read-Only
#    - Shims: Read-Only (these execute mise which then finds tools)
#    - Trust Persistence: map PROJECT_DIR/.local/state/mise to ~/.local/state/mise
opt_bind "${HOME}/.local/share/mise" "/home/scoder/.local/share/mise"
opt_bind "${HOME}/.config/mise" "/home/scoder/.config/mise"

# Add mise shims to PATH if they exist
if [[ -d "${HOME}/.local/share/mise/shims" ]]; then
    SANDBOX_PATH="${SANDBOX_PATH}:/home/scoder/.local/share/mise/shims"
fi

# Create project-local state dir for mise if it doesn't exist
if [[ -n "${PROJECT_DIR}" ]]; then
    mkdir -p "${PROJECT_DIR}/.local/state/mise"
    EXTRA_BINDS+=(--bind "${PROJECT_DIR}/.local/state/mise" "/home/scoder/.local/state/mise")
fi

# 3. Rust toolchains (if exists)
opt_bind "${HOME}/.rustup" "/home/scoder/.rustup"

# Project-local Cargo binaries
if [[ -d "${PROJECT_DIR}/.cargo/bin" ]]; then
    EXTRA_BINDS+=(--bind "${PROJECT_DIR}/.cargo/bin" "/home/scoder/.cargo/bin")
    SANDBOX_PATH="/home/scoder/.cargo/bin:${SANDBOX_PATH}"
fi

# User Cargo binaries (fallback)
if [[ -d "${HOME}/.cargo/bin" ]]; then
    EXTRA_BINDS+=(--ro-bind "${HOME}/.cargo/bin" "/home/scoder/.cargo-home/bin")
    SANDBOX_PATH="${SANDBOX_PATH}:/home/scoder/.cargo-home/bin"
fi

# 4. Python virtual environments (project-local)
if [[ -d "${PROJECT_DIR}/.venv/bin" ]]; then
    EXTRA_BINDS+=(--bind "${PROJECT_DIR}/.venv/bin" "/home/scoder/workspace/.venv/bin")
    SANDBOX_PATH="/home/scoder/workspace/.venv/bin:${SANDBOX_PATH}"
fi

# 5. Node.js project-local binaries
if [[ -d "${PROJECT_DIR}/node_modules/.bin" ]]; then
    EXTRA_BINDS+=(--bind "${PROJECT_DIR}/node_modules/.bin" "/home/scoder/workspace/node_modules/.bin")
    SANDBOX_PATH="/home/scoder/workspace/node_modules/.bin:${SANDBOX_PATH}"
fi

# 6. Go project-local binaries
if [[ -d "${PROJECT_DIR}/bin" && -f "${PROJECT_DIR}/go.mod" ]]; then
    EXTRA_BINDS+=(--bind "${PROJECT_DIR}/bin" "/home/scoder/workspace/bin")
    SANDBOX_PATH="/home/scoder/workspace/bin:${SANDBOX_PATH}"
fi

# 7. Ruby gems (if needed - uncomment if you use Ruby)
# opt_bind "${HOME}/.gem" "/home/scoder/.gem"

# 8. Config files (Read-Only, only if they exist)
if [[ -f "${HOME}/.npmrc" ]]; then
    EXTRA_BINDS+=(--ro-bind "${HOME}/.npmrc" "/home/scoder/.npmrc")
fi
if [[ -f "${HOME}/.pypirc" ]]; then
    EXTRA_BINDS+=(--ro-bind "${HOME}/.pypirc" "/home/scoder/.pypirc")
fi

# -------- run sandbox --------

# Git Safety: Ensure .git in workspace is Read-Only unless --allow-git is passed
GIT_BINDS=()
if [[ "${ALLOW_GIT}" -eq 0 && -d "${PROJECT_DIR}/.git" ]]; then
    GIT_BINDS+=(--ro-bind "${PROJECT_DIR}/.git" "/home/scoder/workspace/.git")
fi

# Build bwrap command with portable mounts
BWRAP_CMD=(
    bwrap
    --ro-bind /usr /usr
    --ro-bind /bin /bin
    --ro-bind /lib /lib
)

# Add /lib64 only if it exists (for 64-bit systems)
[[ -d /lib64 ]] && BWRAP_CMD+=(--ro-bind /lib64 /lib64)

# Add /sys and /run for better compatibility
[[ -d /sys ]] && BWRAP_CMD+=(--ro-bind /sys /sys)
[[ -d /run ]] && BWRAP_CMD+=(--ro-bind /run /run)

# Add /etc
BWRAP_CMD+=(--ro-bind /etc /etc)

# Handle /dev access based on --restrict-dev flag
if [[ "${RESTRICT_DEV}" -eq 1 ]]; then
    BWRAP_CMD+=(
        --dev-bind /dev/null /dev/null
        --dev-bind /dev/zero /dev/zero
        --dev-bind /dev/random /dev/random
        --dev-bind /dev/urandom /dev/urandom
        --dev-bind /dev/tty /dev/tty
        --tmpfs /dev/shm
    )
else
    BWRAP_CMD+=(--dev /dev)
fi

# Continue with remaining mounts
BWRAP_CMD+=(
    --proc /proc
    --tmpfs /tmp
    --tmpfs /home
    --dir /home/scoder
    --dir /home/scoder/.local
    --dir /home/scoder/.local/share
    --dir /home/scoder/.config
    --dir /home/scoder/.cache
    "${EXTRA_BINDS[@]}"
    "${BIND_FLAG}" "${PROJECT_DIR}" /home/scoder/workspace
    "${GIT_BINDS[@]}"
    --bind "${OPENCODE_CONFIG}" /home/scoder/.config/opencode
    --bind "${OPENCODE_DATA}" /home/scoder/.local/share/opencode
    --bind "${OPENCODE_CACHE}" /home/scoder/.cache/opencode
    --chdir /home/scoder/workspace
    "${NET_FLAGS[@]}"
    --new-session
    --die-with-parent
    --clearenv
    --setenv PATH "${SANDBOX_PATH}"
    --setenv HOME /home/scoder
    --setenv USER scoder
    --setenv LOGNAME scoder
    --setenv MISE_SKIP_ACTIVATE 1
    "${OPENCODE_BIN}" "${OPENCODE_ARGS[@]}"
)

exec "${BWRAP_CMD[@]}"
