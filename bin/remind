#!/usr/bin/env bash
# remind - Quick reference for commonly forgotten commands
# Usage: remind [category|file]
# Categories: markdown, pdf, zsh, containers, security

set -euo pipefail

VERSION="2.2.0"
SCRIPT_NAME="$(basename "$0")"

# Colors for output
if [[ -t 1 ]]; then
    DIM='\033[2m'
    RESET='\033[0m'
    BLUE='\033[34m'
    GREEN='\033[32m'
    YELLOW='\033[33m'
    RED='\033[31m'
else
    DIM='' RESET='' BLUE='' GREEN='' YELLOW='' RED=''
fi

show_version() {
    echo "$SCRIPT_NAME version $VERSION"
}

show_help() {
    cat <<EOF
$SCRIPT_NAME - Quick reference for commonly forgotten commands

USAGE:
    $SCRIPT_NAME [OPTIONS] [CATEGORY|FILE]

OPTIONS:
    -h, --help       Show this help message
    -v, --version    Show version information
    -i, --install    Show installation commands instead of usage

CATEGORIES:
    markdown, md     Markdown to PDF conversion commands
    pdf              PDF manipulation (split/merge/etc)
    zsh, shell       Modern zsh/shell utilities
    containers       Container management (Podman)
    security         Sandboxing tools (bubblewrap, landrun)

EXAMPLES:
    $SCRIPT_NAME                    # Show all categories
    $SCRIPT_NAME zsh                # Show zsh tools usage
    $SCRIPT_NAME -i zsh             # Show zsh tools installation
    $SCRIPT_NAME markdown           # Show markdown conversion help
    $SCRIPT_NAME file.md            # Auto-detect from file extension

AUTHOR:
    Andres Monge (aemonge)
EOF
}

# ============================================================================
# MARKDOWN CATEGORY
# ============================================================================

show_markdown_help() {
    echo -e "${BLUE}go-grip --theme dark file.md${RESET}"
    echo -e "${DIM}# Opens in browser, use Print to PDF (Ctrl+P)${RESET}"
    echo ""
    echo "Options: --theme light | --theme dark"
}

show_markdown_install() {
    echo -e "${GREEN}Install go-grip:${RESET}"
    echo -e "  ${BLUE}pamac build go-grip-git${RESET}        ${DIM}# AUR (common on Manjaro)${RESET}"
    echo -e "  ${BLUE}yay -S go-grip-git${RESET}             ${DIM}# AUR alternative${RESET}"
    echo ""
    echo -e "${DIM}Alternative (no package manager):${RESET}"
    echo -e "  ${BLUE}go install github.com/chrishrb/go-grip@latest${RESET}"
}

# ============================================================================
# PDF CATEGORY
# ============================================================================

show_pdf_help() {
    echo "Merge:"
    echo -e "  ${BLUE}pdfunite file1.pdf file2.pdf output.pdf${RESET}"
    echo -e "  ${BLUE}qpdf --empty --pages file*.pdf -- merged.pdf${RESET}"
    echo ""
    echo "Split:"
    echo -e "  ${BLUE}pdfseparate input.pdf output_%d.pdf${RESET}"
    echo -e "  ${BLUE}pdftk input.pdf burst${RESET}"
    echo ""
    echo "Extract pages:"
    echo -e "  ${BLUE}qpdf input.pdf --pages . 5-10 -- output.pdf${RESET}"
    echo ""
    echo "Info:"
    echo -e "  ${BLUE}pdfinfo file.pdf${RESET}"
    echo -e "  ${BLUE}qpdf --show-npages file.pdf${RESET}"
    echo ""
    echo "Rotate:"
    echo -e "  ${BLUE}qpdf input.pdf --rotate=90:1-z -- rotated.pdf${RESET}"
    echo ""
    echo "Compress:"
    echo -e "  ${BLUE}gs -sDEVICE=pdfwrite -dPDFSETTINGS=/ebook -dNOPAUSE -dQUIET \\${RESET}"
    echo -e "  ${BLUE}     -dBATCH -sOutputFile=compressed.pdf input.pdf${RESET}"
    echo ""
    echo "To images:"
    echo -e "  ${BLUE}pdftoppm -png input.pdf output${RESET}"
    echo ""
    echo "Encrypt:"
    echo -e "  ${BLUE}qpdf --encrypt PASS PASS 256 -- input.pdf encrypted.pdf${RESET}"
}

show_pdf_install() {
    echo -e "${GREEN}Install PDF tools:${RESET}"
    echo -e "  ${BLUE}pamac install poppler qpdf pdftk ghostscript${RESET}"
    echo -e "${DIM}Notes: pdfunite/pdfseparate/pdfinfo come from poppler; gs comes from ghostscript.${RESET}"
}

# ============================================================================
# ZSH MODERN TOOLS CATEGORY
# ============================================================================

show_zsh_help() {
    echo -e "${GREEN}Core Shell Utilities:${RESET}"
    echo ""
    echo -e "${YELLOW}Navigation & History:${RESET}"
    echo -e "  ${BLUE}z project${RESET}                    # Jump to frecent directory (zoxide)"
    echo -e "  ${BLUE}Ctrl+R${RESET}                       # Search history with context (atuin)"
    echo ""
    echo -e "${YELLOW}Modern CLI Replacements:${RESET}"
    echo -e "  ${BLUE}ls${RESET} / ${BLUE}l${RESET} / ${BLUE}ll${RESET} / ${BLUE}lll${RESET}         # Modern ls with icons (eza)"
    echo -e "  ${BLUE}grep${RESET} / ${BLUE}g 'pattern'${RESET}         # Blazing fast search (ripgrep)"
    echo -e "  ${BLUE}sed 's/old/new/' file${RESET}      # Intuitive find/replace (sd)"
    echo -e "  ${BLUE}ps${RESET} / ${BLUE}psall${RESET}                  # Modern process viewer (procs)"
    echo -e "  ${BLUE}top${RESET}                          # Interactive system monitor (bottom)"
    echo -e "  ${BLUE}c file.{md,json,jpg}${RESET}        # Smart cat with viewers (bat/glow/feh)"
    echo -e "  ${BLUE}df${RESET}                           # Disk usage with colors (duf)"
    echo -e "  ${BLUE}du${RESET}                           # Interactive disk analyzer (dua)"
    echo -e "  ${BLUE}diff file1 file2${RESET}            # Git-aware diff (delta)"
    echo -e "  ${BLUE}man command${RESET}                 # Syntax-highlighted man pages (batman from bat-extras)"
    echo -e "  ${BLUE}extract archive.zip${RESET}         # Universal extractor (ouch)"
    echo -e "  ${BLUE}tldr command${RESET}                # Quick command examples (tealdeer)"
    echo -e "  ${BLUE}bench 'cmd1' 'cmd2'${RESET}         # Benchmark commands (hyperfine)"
    echo ""
    echo -e "${YELLOW}Network & System:${RESET}"
    echo -e "  ${BLUE}lsport${RESET}                       # List listening ports (ss)"
    echo -e "  ${BLUE}lsip${RESET}                         # List IP addresses (ip)"
    echo -e "  ${BLUE}usball${RESET}                       # List USB devices (lsusb)"
    echo ""
    echo -e "${YELLOW}Development Tools:${RESET}"
    echo -e "  ${BLUE}http-serve [port]${RESET}           # Python HTTP server (default: 8000)"
    echo -e "  ${BLUE}http-serve-rs [port] [dir]${RESET} # Rust HTTP server (miniserve)"
    echo -e "  ${BLUE}e${RESET}                            # Emoji picker (bemoji + fzf)"
    echo ""
    echo -e "${DIM}See ~/.aliases for full documentation${RESET}"
}

show_zsh_install() {
    echo -e "${GREEN}Core Shell Utilities:${RESET}"
    echo ""
    echo -e "${YELLOW}Essential (Navigation & History):${RESET}"
    echo -e "  ${BLUE}pamac install atuin zoxide${RESET}"
    echo ""
    echo -e "${YELLOW}Modern CLI Replacements:${RESET}"
    echo -e "  ${BLUE}pamac install eza fd ripgrep bat bat-extras vivid${RESET}"
    echo -e "  ${BLUE}pamac install sd procs tealdeer bottom ouch${RESET}"
    echo -e "  ${BLUE}pamac install duf dua-cli lnav git-delta${RESET}"
    echo -e "  ${BLUE}pamac install hyperfine${RESET}"
    echo ""
    echo -e "${YELLOW}TUI & Utilities:${RESET}"
    echo -e "  ${BLUE}pamac install fzf fzy bemoji glow jq yq${RESET}"
    echo -e "  ${BLUE}pamac install miniserve${RESET}         # Rust HTTP server"
    echo -e "  ${BLUE}pamac install vi-mongo visidata${RESET} # TUI database/data tools"
    echo ""
    echo -e "${YELLOW}Optional Fun:${RESET}"
    echo -e "  ${BLUE}pamac install lolcat sl trash-cli${RESET}"
    echo ""
    echo -e "${DIM}Full list:${RESET}"
    echo -e "${DIM}  atuin zoxide eza fd ripgrep bat bat-extras vivid${RESET}"
    echo -e "${DIM}  sd procs tealdeer bottom ouch duf dua-cli lnav git-delta${RESET}"
    echo -e "${DIM}  hyperfine fzf fzy bemoji glow jq yq miniserve vi-mongo visidata${RESET}"
}

# ============================================================================
# CONTAINERS CATEGORY
# ============================================================================

show_containers_help() {
    echo -e "${RED}⚠️  Use Podman instead of Docker${RESET}"
    echo ""
    echo -e "${GREEN}Why Podman?${RESET}"
    echo -e "  • ${YELLOW}Daemonless${RESET} - no background process"
    echo -e "  • ${YELLOW}Rootless${RESET} - runs without sudo"
    echo -e "  • ${YELLOW}Docker CLI compatible${RESET} - drop-in replacement"
    echo -e "  • ${YELLOW}OCI compliant${RESET} - runs all Docker images"
    echo ""
    echo -e "${GREEN}Common Commands:${RESET}"
    echo -e "  ${BLUE}podman run -it alpine${RESET}"
    echo -e "  ${BLUE}podman ps${RESET}"
    echo -e "  ${BLUE}podman images${RESET}"
    echo -e "  ${BLUE}podman-compose up -d${RESET}"
    echo ""
    echo -e "${DIM}@see: https://podman.io/${RESET}"
}

show_containers_install() {
    echo -e "${GREEN}Install Podman:${RESET}"
    echo -e "  ${BLUE}pamac install podman podman-compose${RESET}"
    echo ""
    echo -e "${DIM}After install, Podman commands are identical to Docker:${RESET}"
    echo -e "  ${GREEN}podman run${RESET} instead of ${RED}docker run${RESET}"
    echo -e "  ${GREEN}podman-compose up${RESET} instead of ${RED}docker-compose up${RESET}"
}

# ============================================================================
# SECURITY CATEGORY
# ============================================================================

show_security_help() {
    echo -e "${GREEN}Bubblewrap (bwrap)${RESET} - Low-level sandboxing (used by Flatpak)"
    echo ""
    echo -e "${YELLOW}Basic sandbox:${RESET}"
    echo -e "  ${BLUE}bwrap --ro-bind /usr /usr --tmpfs /tmp --proc /proc \\${RESET}"
    echo -e "  ${BLUE}      --dev /dev --unshare-all --share-net \\${RESET}"
    echo -e "  ${BLUE}      /usr/bin/command${RESET}"
    echo ""
    echo -e "${YELLOW}Isolate with custom home:${RESET}"
    echo -e "  ${BLUE}bwrap --ro-bind /usr /usr --bind ~/sandbox ~/sandbox \\${RESET}"
    echo -e "  ${BLUE}      --tmpfs /tmp --proc /proc --dev /dev \\${RESET}"
    echo -e "  ${BLUE}      --unshare-all --setenv HOME ~/sandbox \\${RESET}"
    echo -e "  ${BLUE}      /usr/bin/firefox --no-remote${RESET}"
    echo ""
    echo -e "${GREEN}Landrun${RESET} - Kernel-native sandboxing via Landlock LSM"
    echo ""
    echo -e "${YELLOW}Basic usage:${RESET}"
    echo -e "  ${BLUE}landrun --ro /usr --rw /tmp command${RESET}"
    echo ""
    echo -e "${YELLOW}Restrict filesystem access:${RESET}"
    echo -e "  ${BLUE}landrun --ro /usr/bin/python3 --rw ./data \\${RESET}"
    echo -e "  ${BLUE}        /usr/bin/python3 script.py${RESET}"
    echo ""
    echo -e "${YELLOW}Network restrictions:${RESET}"
    echo -e "  ${BLUE}landrun --ro /usr --no-net command${RESET}"
    echo -e "  ${BLUE}landrun --ro /usr --tcp-bind 8080 server${RESET}"
    echo ""
    echo -e "${DIM}Bubblewrap: Fine-grained control with namespaces (complex)${RESET}"
    echo -e "${DIM}Landrun: Simple CLI, kernel-native, no root required${RESET}"
    echo -e "${DIM}@see: https://wiki.archlinux.org/title/Bubblewrap${RESET}"
    echo -e "${DIM}@see: https://github.com/Zouuup/landrun${RESET}"
}

show_security_install() {
    echo -e "${GREEN}Bubblewrap:${RESET}"
    echo -e "  ${BLUE}pamac install bubblewrap${RESET}"
    echo ""
    echo -e "${DIM}Note: Some hardened setups may need bubblewrap-suid (if available).${RESET}"
    echo ""
    echo -e "${GREEN}Landrun:${RESET}"
    echo -e "  ${BLUE}yay -S landrun${RESET}              ${DIM}# From AUR${RESET}"
    echo ""
    echo -e "${DIM}Or install from source:${RESET}"
    echo -e "  ${BLUE}git clone https://github.com/Zouuup/landrun${RESET}"
    echo -e "  ${BLUE}cd landrun && go build && sudo cp landrun /usr/local/bin/${RESET}"
    echo ""
    echo -e "${DIM}Requirements: Linux kernel >= 5.13 (for Landlock support)${RESET}"
}

# ============================================================================
# MAIN LOGIC
# ============================================================================

show_all_categories() {
    echo "Categories:"
    echo -e "  ${YELLOW}markdown${RESET}, ${YELLOW}md${RESET}      Markdown to PDF conversion"
    echo -e "  ${YELLOW}pdf${RESET}              PDF manipulation (merge/split/etc)"
    echo -e "  ${YELLOW}zsh${RESET}, ${YELLOW}shell${RESET}       Modern shell utilities & CLI tools"
    echo -e "  ${YELLOW}containers${RESET}       Container management (Podman)"
    echo -e "  ${YELLOW}security${RESET}         Sandboxing tools (bubblewrap, landrun)"
    echo ""
    echo "Usage:"
    echo "  $SCRIPT_NAME [category]"
    echo "  $SCRIPT_NAME -i [category]    # Show installation commands"
}

detect_category() {
    local input="$1"

    case "$input" in
    *.md | markdown | md)
        echo "markdown"
        ;;
    *.pdf | pdf)
        echo "pdf"
        ;;
    zsh | shell | cli)
        echo "zsh"
        ;;
    containers | podman | docker)
        echo "containers"
        ;;
    security | sandbox | bwrap | bubblewrap | landrun)
        echo "security"
        ;;
    *)
        echo "$input"
        ;;
    esac
}

main() {
    local category=""
    local show_install=false

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
        -h | --help)
            show_help
            exit 0
            ;;
        -v | --version)
            show_version
            exit 0
            ;;
        -i | --install)
            show_install=true
            shift
            ;;
        -*)
            echo "Error: Unknown option: $1" >&2
            echo "Run '$SCRIPT_NAME --help' for usage information" >&2
            exit 1
            ;;
        *)
            category="$1"
            shift
            ;;
        esac
    done

    # If no category provided, show all
    if [[ -z "$category" ]]; then
        show_all_categories
        exit 0
    fi

    # Detect category from input
    category="$(detect_category "$category")"

    case "$category" in
    markdown | md)
        if [[ "$show_install" == true ]]; then
            show_markdown_install
        else
            show_markdown_help
        fi
        ;;
    pdf)
        if [[ "$show_install" == true ]]; then
            show_pdf_install
        else
            show_pdf_help
        fi
        ;;
    zsh)
        if [[ "$show_install" == true ]]; then
            show_zsh_install
        else
            show_zsh_help
        fi
        ;;
    containers)
        if [[ "$show_install" == true ]]; then
            show_containers_install
        else
            show_containers_help
        fi
        ;;
    security)
        if [[ "$show_install" == true ]]; then
            show_security_install
        else
            show_security_help
        fi
        ;;
    *)
        echo "Error: Unknown category '$category'" >&2
        echo "Run '$SCRIPT_NAME --help' for available categories" >&2
        exit 1
        ;;
    esac
}

main "$@"
