#!/usr/bin/env bash
# remind - Quick reference for commonly forgotten commands
# Usage: remind [category|file]
# Categories: markdown, pdf, zsh, containers, security, cloud

set -euo pipefail

VERSION="2.2.0"
SCRIPT_NAME="$(basename "$0")"

# Colors for output
if [[ -t 1 ]]; then
    DIM='\033[2m'
    RESET='\033[0m'
    BLUE='\033[34m'
    GREEN='\033[32m'
    YELLOW='\033[33m'
    RED='\033[31m'
else
    DIM='' RESET='' BLUE='' GREEN='' YELLOW='' RED=''
fi

show_version() {
    echo "$SCRIPT_NAME version $VERSION"
}

show_help() {
    cat <<EOF
$SCRIPT_NAME - Quick reference for commonly forgotten commands

USAGE:
    $SCRIPT_NAME [OPTIONS] [CATEGORY|FILE]

OPTIONS:
    -h, --help       Show this help message
    -v, --version    Show version information
    -i, --install    Show installation commands instead of usage

CATEGORIES:
    markdown, md     Markdown to PDF conversion commands
    cloud            Cloud storage tools (pCloud)
    pdf              PDF manipulation (split/merge/etc)
    zsh, shell       Modern zsh/shell utilities
    containers       Container management (Podman)
    security         Sandboxing tools (bubblewrap, landrun)

EXAMPLES:
    $SCRIPT_NAME                    # Show all categories
    $SCRIPT_NAME zsh                # Show zsh tools usage
    $SCRIPT_NAME -i zsh             # Show zsh tools installation
    $SCRIPT_NAME markdown           # Show markdown conversion help
    $SCRIPT_NAME file.md            # Auto-detect from file extension

AUTHOR:
    Andres Monge (aemonge)
EOF
}

# ============================================================================
# MARKDOWN CATEGORY
# ============================================================================

show_markdown_help() {
    echo -e "${BLUE}go-grip --theme dark file.md${RESET}"
    echo -e "${DIM}# Opens in browser, use Print to PDF (Ctrl+P)${RESET}"
    echo ""
    echo "Options: --theme light | --theme dark"
}

show_markdown_install() {
    echo -e "${GREEN}Install go-grip:${RESET}"
    echo -e "  ${BLUE}pamac build go-grip-git${RESET}"
}

# ============================================================================
# PDF CATEGORY
# ============================================================================

show_pdf_help() {
    echo -e "${BLUE}pdftk file1.pdf file2.pdf cat output merged.pdf${RESET}"
    echo -e "${DIM}# Merge PDFs${RESET}"
    echo ""
    echo -e "${BLUE}pdfseparate input.pdf page-%d.pdf${RESET}"
    echo -e "${DIM}# Split PDF into pages${RESET}"
    echo ""
    echo -e "${BLUE}pdfunite page-1.pdf page-2.pdf output.pdf${RESET}"
    echo -e "${DIM}# Merge pages back into a PDF${RESET}"
}

show_pdf_install() {
    echo -e "${GREEN}Install PDF tools:${RESET}"
    echo -e "  ${BLUE}pamac install poppler${RESET}          ${DIM}# pdfseparate/pdfunite${RESET}"
    echo -e "  ${BLUE}pamac install pdftk${RESET}            ${DIM}# pdftk${RESET}"
}

# ============================================================================
# ZSH / SHELL CATEGORY
# ============================================================================

show_zsh_help() {
    echo -e "${BLUE}atuin search <query>${RESET}"
    echo -e "${DIM}# Search shell history (sync optional)${RESET}"
    echo ""
    echo -e "${BLUE}zoxide query <dir>${RESET}"
    echo -e "${DIM}# Smarter cd${RESET}"
    echo ""
    echo -e "${BLUE}eza -lah --git${RESET}"
    echo -e "${DIM}# Modern ls replacement${RESET}"
    echo ""
    echo -e "${BLUE}bat file.txt${RESET}"
    echo -e "${DIM}# cat with syntax highlighting${RESET}"
}

show_zsh_install() {
    echo -e "${GREEN}Install modern CLI tools:${RESET}"
    echo -e "  ${BLUE}pamac install atuin zoxide eza bat fd ripgrep fzf${RESET}"
}

# ============================================================================
# CONTAINERS CATEGORY
# ============================================================================

show_containers_help() {
    echo -e "${BLUE}podman ps -a${RESET}"
    echo -e "${DIM}# List containers${RESET}"
    echo ""
    echo -e "${BLUE}podman images${RESET}"
    echo -e "${DIM}# List images${RESET}"
    echo ""
    echo -e "${BLUE}podman compose up -d${RESET}"
    echo -e "${DIM}# Bring up a compose stack${RESET}"
}

show_containers_install() {
    echo -e "${GREEN}Install Podman stack:${RESET}"
    echo -e "  ${BLUE}pamac install podman podman-compose buildah${RESET}"
}

# ============================================================================
# SECURITY CATEGORY
# ============================================================================

show_security_help() {
    echo -e "${BLUE}bwrap --ro-bind /usr /usr --ro-bind /lib /lib --ro-bind /lib64 /lib64 --proc /proc --dev /dev --tmpfs /tmp --unshare-all --die-with-parent --new-session <cmd>${RESET}"
    echo -e "${DIM}# Bubblewrap sandbox example${RESET}"
    echo ""
    echo -e "${BLUE}landrun --config <profile.toml> <cmd>${RESET}"
    echo -e "${DIM}# Landrun (Landlock) sandbox with a config profile${RESET}"
}

show_security_install() {
    echo -e "${GREEN}Bubblewrap:${RESET}"
    echo -e "  ${BLUE}pamac install bubblewrap${RESET}"
    echo ""
    echo -e "${DIM}Note: Some hardened setups may need bubblewrap-suid (if available).${RESET}"
    echo ""
    echo -e "${GREEN}Landrun:${RESET}"
    echo -e "  ${BLUE}yay -S landrun${RESET}              ${DIM}# From AUR${RESET}"
    echo ""
    echo -e "${DIM}Or install from source:${RESET}"
    echo -e "  ${BLUE}git clone https://github.com/Zouuup/landrun${RESET}"
    echo -e "  ${BLUE}cd landrun && go build && sudo cp landrun /usr/local/bin/${RESET}"
    echo ""
    echo -e "${DIM}Requirements: Linux kernel >= 5.13 (for Landlock support)${RESET}"
}

# ============================================================================
# CLOUD CATEGORY
# ============================================================================

show_cloud_help() {
    echo -e "${BLUE}pcloud-drive${RESET}"
    echo -e "${DIM}# Official pCloud client (set-and-forget daemon with Crypto support)${RESET}"
}

show_cloud_install() {
    echo -e "${GREEN}Install pCloud Drive:${RESET}"
    echo -e "  ${BLUE}pamac build pcloud-drive${RESET}"
}

# ============================================================================
# MAIN LOGIC
# ============================================================================

show_all_categories() {
    echo "Categories:"
    echo -e "  ${YELLOW}markdown${RESET}, ${YELLOW}md${RESET}      Markdown to PDF conversion"
    echo -e "  ${YELLOW}cloud${RESET}            Cloud storage tools (pCloud)"
    echo -e "  ${YELLOW}pdf${RESET}              PDF manipulation (merge/split/etc)"
    echo -e "  ${YELLOW}zsh${RESET}, ${YELLOW}shell${RESET}       Modern shell utilities & CLI tools"
    echo -e "  ${YELLOW}containers${RESET}       Container management (Podman)"
    echo -e "  ${YELLOW}security${RESET}         Sandboxing tools (bubblewrap, landrun)"
    echo ""
    echo "Usage:"
    echo "  $SCRIPT_NAME [category]"
    echo "  $SCRIPT_NAME -i [category]    # Show installation commands"
}

detect_category() {
    local input="$1"

    case "$input" in
    cloud | pcloud)
        echo "cloud"
        ;;
    *.md | markdown | md)
        echo "markdown"
        ;;
    *.pdf | pdf)
        echo "pdf"
        ;;
    zsh | shell | cli)
        echo "zsh"
        ;;
    containers | podman | docker)
        echo "containers"
        ;;
    security | sandbox | bwrap | bubblewrap | landrun)
        echo "security"
        ;;
    *)
        echo "$input"
        ;;
    esac
}

main() {
    local category=""
    local show_install=false

    # Parse arguments
    while [[ $# -gt 0 ]]; do
        case "$1" in
        -h | --help)
            show_help
            exit 0
            ;;
        -v | --version)
            show_version
            exit 0
            ;;
        -i | --install)
            show_install=true
            shift
            ;;
        -*)
            echo "Error: Unknown option: $1" >&2
            echo "Run '$SCRIPT_NAME --help' for usage information" >&2
            exit 1
            ;;
        *)
            category="$1"
            shift
            ;;
        esac
    done

    # If no category provided, show all
    if [[ -z "$category" ]]; then
        show_all_categories
        exit 0
    fi

    # Detect category from input
    category="$(detect_category "$category")"

    case "$category" in
    markdown | md)
        if [[ "$show_install" == true ]]; then
            show_markdown_install
        else
            show_markdown_help
        fi
        ;;
    pdf)
        if [[ "$show_install" == true ]]; then
            show_pdf_install
        else
            show_pdf_help
        fi
        ;;
    zsh)
        if [[ "$show_install" == true ]]; then
            show_zsh_install
        else
            show_zsh_help
        fi
        ;;
    containers)
        if [[ "$show_install" == true ]]; then
            show_containers_install
        else
            show_containers_help
        fi
        ;;
    security)
        if [[ "$show_install" == true ]]; then
            show_security_install
        else
            show_security_help
        fi
        ;;
    cloud)
        if [[ "$show_install" == true ]]; then
            show_cloud_install
        else
            show_cloud_help
        fi
        ;;
    *)
        echo "Error: Unknown category '$category'" >&2
        echo "Run '$SCRIPT_NAME --help' for available categories" >&2
        exit 1
        ;;
    esac
}

main "$@"
